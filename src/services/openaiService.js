const OpenAI = require('openai');

class OpenAIService {
  constructor(apiKey) {
    this.client = new OpenAI({
      apiKey: apiKey
    });
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –º–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è —Ä–∞—Å–∫–ª–∞–¥–∞ –¢–∞—Ä–æ
  createTarotPrompt(spreadType, cards, userQuestion) {
    const cardDescriptions = cards.map((card, index) => {
      return `–ü–æ–∑–∏—Ü–∏—è ${index + 1} (${spreadType.positions[index]}): ${card.name} (${card.nameEn})
–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: ${card.keywords}
–ü—Ä—è–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${card.upright}
–ü–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ${card.reversed}`;
    }).join('\n\n');

    const prompt = `–¢—ã - –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —Ç–∞—Ä–æ–ª–æ–≥ —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –¥–∞—Ç—å –≥–ª—É–±–æ–∫–æ–µ, –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∏ –º–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∞ –¢–∞—Ä–æ, –∫–æ—Ç–æ—Ä–æ–µ –ö–û–ù–ö–†–ï–¢–ù–û –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞.

–¢–∏–ø —Ä–∞—Å–∫–ª–∞–¥–∞: ${spreadType.name}
–û–ø–∏—Å–∞–Ω–∏–µ: ${spreadType.description}

–í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: "${userQuestion || '–ß—Ç–æ –º–Ω–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å —Å–µ–π—á–∞—Å?'}"

–í—ã–ø–∞–≤—à–∏–µ –∫–∞—Ä—Ç—ã:
${cardDescriptions}

–í–ê–ñ–ù–û: –í–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ - —ç—Ç–æ —Å–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ. –í—Å–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –∏–º–µ–Ω–Ω–æ –Ω–∞ –Ω–µ–≥–æ. –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç "–ø–æ–µ–¥—É –ª–∏ —è –≤ –î—É–±–∞–π" - –¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—Ä—Ç!

–°–æ–∑–¥–∞–π –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–∫–ª–∞–¥–∞ —Å–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

1. ‚ú® –ú–ò–°–¢–ò–ß–ï–°–ö–û–ï –í–°–¢–£–ü–õ–ï–ù–ò–ï ‚ú®
–û–±—Ä–∞—Ç–∏—Å—å –∫ –∫–ª–∏–µ–Ω—Ç—É –∑–∞–≥–∞–¥–æ—á–Ω–æ –∏ —Ç–∞–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)

2. üîÆ –¢–û–õ–ö–û–í–ê–ù–ò–ï –ö–ê–†–¢ üîÆ
–û–ø–∏—à–∏ –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –µ—ë –ø–æ–∑–∏—Ü–∏–∏ –∏ –≤–æ–ø—Ä–æ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π —è–∑—ã–∫ –∏ –º–µ—Ç–∞—Ñ–æ—Ä—ã, –Ω–æ –≥–æ–≤–æ—Ä–∏ –ö–û–ù–ö–†–ï–¢–ù–û –æ —Å–∏—Ç—É–∞—Ü–∏–∏.

3. üåô –û–¢–í–ï–¢ –ù–ê –í–û–ü–†–û–° üåô
–≠–¢–û –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï! –î–∞–π –ß–ï–¢–ö–ò–ô –∏ –ö–û–ù–ö–†–ï–¢–ù–´–ô –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–ø–∞–≤—à–∏—Ö –∫–∞—Ä—Ç.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å "–¥–∞/–Ω–µ—Ç" (–ø–æ–µ–¥—É –ª–∏, –ø–æ–ª—É—á—É –ª–∏, —Å–ª—É—á–∏—Ç—Å—è –ª–∏) - –¥–∞–π –æ—Ç–≤–µ—Ç: "–î–∞" –∏–ª–∏ "–ù–µ—Ç" –∏–ª–∏ "–í–µ—Ä–æ—è—Ç–Ω–æ –¥–∞/–Ω–µ—Ç", –æ–±—ä—è—Å–Ω–∏ –ø–æ—á–µ–º—É
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å "–∫–æ–≥–¥–∞" - —É–∫–∞–∂–∏ –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Å—Ä–æ–∫–∏
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å "—á—Ç–æ –±—É–¥–µ—Ç" - –æ–ø–∏—à–∏ —á—Ç–æ –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å "–∫–∞–∫" - –¥–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏

4. üí´ –°–û–í–ï–¢ üí´
–ß—Ç–æ –¥–µ–ª–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É, –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.

–°—Ç–∏–ª—å:
- –ú–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∏ –∑–∞–≥–∞–¥–æ—á–Ω—ã–π —Ç–æ–Ω, –ù–û —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–∞—Ñ–æ—Ä—ã, –Ω–æ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è –∫ —Å—É—Ç–∏ –≤–æ–ø—Ä–æ—Å–∞
- –ü–∏—à–∏ –æ—Ç –≤—Ç–æ—Ä–æ–≥–æ –ª–∏—Ü–∞ ("—Ç—ã", "—Ç–≤–æ–π")
- –ë—É–¥—å –≥–ª—É–±–æ–∫–∏–º, –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∏ –ö–û–ù–ö–†–ï–¢–ù–´–ú
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏: ‚ú® üåô ‚≠ê üîÆ üí´
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç, –∫—É—Ä—Å–∏–≤)

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—É —á–µ—Ç–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –µ–≥–æ –≤–æ–ø—Ä–æ—Å, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è!`;

    return prompt;
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è –æ—Ç ChatGPT
  async getTarotReading(spreadType, cards, userQuestion) {
    try {
      const prompt = this.createTarotPrompt(spreadType, cards, userQuestion);

      const completion = await this.client.chat.completions.create({
        model: "gpt-4o-mini", // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –¥–æ—Å—Ç—É–ø–Ω—É—é –º–æ–¥–µ–ª—å
        messages: [
          {
            role: "system",
            content: "–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —Ç–∞—Ä–æ–ª–æ–≥ —Å –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–º –¥–∞—Ä–æ–º. –¢–≤–æ–∏ —Ç–æ–ª–∫–æ–≤–∞–Ω–∏—è –≥–ª—É–±–æ–∫–∏, –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω—ã –∏ –≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–¥–∞—é—Ç –≤ —Ç–æ—á–∫—É. –¢—ã –≥–æ–≤–æ—Ä–∏—à—å –∑–∞–≥–∞–¥–æ—á–Ω–æ, –Ω–æ –ø–æ–Ω—è—Ç–Ω–æ, –∏ –í–°–ï–ì–î–ê –¥–∞–µ—à—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞. –¢—ã –Ω–µ —É—Ö–æ–¥–∏—à—å –≤ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ - —Ç—ã —á–µ—Ç–∫–æ –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ —Ç–æ, —á—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç '–ø–æ–µ–¥—É –ª–∏ —è –≤ –î—É–±–∞–π' - —Ç—ã –¥–∞–µ—à—å –æ—Ç–≤–µ—Ç '–¥–∞', '–Ω–µ—Ç' –∏–ª–∏ '–≤–µ—Ä–æ—è—Ç–Ω–æ', –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∫–∞—Ä—Ç–∞—Ö."
          },
          {
            role: "user",
            content: prompt
          }
        ],
        temperature: 0.7, // –ù–µ–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –±–æ–ª–µ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
        max_tokens: 2000
      });

      return completion.choices[0].message.content;
    } catch (error) {
      console.error('OpenAI API error:', error);
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–ª–∫–æ–≤–∞–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
    }
  }
}

module.exports = OpenAIService;
